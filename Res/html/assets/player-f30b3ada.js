import{r as p,d as V,e as C,u as D,f as I,o as x,c as E,g,w as k,h as R,a as _,j as u,k as b,t as A,F as L,n as F,b as j,i as N}from"./i18n-d9e76cbb.js";import{P as U,u as S,_ as M,E as T,a as J}from"./useMediaStream-faa8f375.js";var r=(l=>(l[l.IDLE=0]="IDLE",l[l.Pulling=1]="Pulling",l[l.Success=2]="Success",l))(r||{});const f=p(0),q=l=>{const m={offerToReceiveAudio:!0,offerToReceiveVideo:!0};let e=null;const y=async(c,a)=>{let s="";const t=new URL(c);return t.protocol?(!t.protocol.includes("http")&&!t.protocol.includes("ws")&&(t.protocol="https",s=t.origin),(await fetch(s+"/x2rtc/v1/pullstream",{method:"POST",body:JSON.stringify({streamurl:c,sessionid:"",localsdp:a})})).json()):void 0},h=async c=>{if(f.value!==0)return;f.value=1;const a=c.replace(/\s/g,""),s={};console.log("RTCPeerConnection configuration:",s),e=new U(s),console.log("Created local peer connection object pc"),e.pc.addEventListener("iceconnectionstatechange",t=>{console.log(`ICE state: ${e==null?void 0:e.pc.iceConnectionState}`),e!=null&&e.isICEConnected&&(f.value=2)}),e.pc.addEventListener("track",t=>{console.log("Recv remote track",t.track),l&&l(t.track)});try{console.log("pc createOffer start"),e.onOffer=async t=>{const{errcode:o,remotesdp:i}=await y(a,t);o===0&&(console.log("pc setRemoteDescription start",i),await(e==null?void 0:e.setRemoteDescription(i)))},await e.createAndSendOffer(m)}catch(t){console.log(`Failed to create session description: ${t.toString()}`)}},v=()=>{e==null||e.close(),e=null,f.value=0};return{pullState:V(f),startPull:h,stopPull:v}},z={class:"flex"},G={class:"w-full flex items-center space-x-4"},H=C({__name:"PlayerAndPreview",setup(l){const{t:m}=D(),{localStream:e,addTrack:y}=S(),h=I(()=>!o.value),v=p(),c=n=>{y(n),w.value||(w.value=!0),F(()=>{v.value.srcObject=e.value})},{pullState:a,startPull:s,stopPull:t}=q(c),o=p(""),i=p(""),w=p(!1),B=async()=>{if(!/^(webrtc):\/\/.*/i.test(o.value))return i.value=m("publicError.invalidUrl");i.value="",a.value!==r.Pulling&&(a.value===r.IDLE?await s(o.value):a.value===r.Success&&t())};return(n,P)=>{const $=T,O=J;return x(),E(L,null,[g(M,{"default-tips":n.$t("previewTips"),"error-message":i.value},{default:k(()=>[w.value?(x(),E("video",{key:0,ref_key:"videoBox",ref:v,class:"w-full h-full",autoplay:"",playsinline:""},null,512)):R("",!0)]),_:1},8,["default-tips","error-message"]),_("div",z,[_("div",G,[g($,{modelValue:o.value,"onUpdate:modelValue":P[0]||(P[0]=d=>o.value=d),class:"!h-[58px] placeholder-7E8181 text-A9ABAB",type:"primary",formatter:d=>d,parser:d=>d.replace(/\s/g,""),placeholder:n.$t("player.inputPlaceholder"),disabled:u(a)!==u(r).IDLE},null,8,["modelValue","formatter","parser","placeholder","disabled"]),g(O,{class:"!h-[58px] !px-10",type:"primary",loading:u(a)===u(r).Pulling,disabled:h.value,onClick:B},{default:k(()=>[b(A(u(a)===u(r).Success?n.$t("player.stopBtn"):n.$t("player.startBtn")),1)]),_:1},8,["loading","disabled"])])])],64)}}}),K={class:"w-full h-full max-h-screen flex justify-center bg-[#F1F1F1] py-20"},Q={class:"container flex"},W={class:"h-full flex-1 flex flex-col space-y-7"},X=C({__name:"App",setup(l){return S(),p(!1),(m,e)=>(x(),E("div",K,[_("div",Q,[_("div",W,[g(H)])])]))}});j(X).use(N).mount("#app");
